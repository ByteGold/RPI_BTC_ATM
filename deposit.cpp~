#include "main.h"
#include "util.h"
#include "deposit.h"
#include "tx.h"
#include "json_rpc.h"

static std::vector<fee_t> fee;
static std::mutex fee_lock;

void deposit::add_fee(fee_t fee_){
  if(fee_.get_percent() > .25){
    print("fee is absurdly high, force with --force-fee", P_CRIT);
    // should be done at runtime
  }
  LOCK_RUN(fee_lock [](int fee_){
      for(int i = 0;i < fee.size();i++){
	bool addr = fee.get_address() == fee_.get_address();
	bool perc = fee.get_percent() == fee_.get_percent();
	if(addr){
	  if(perc){
	    break;
	  }else{
	    print("updating fee, old one should have been deleted", P_ERR);
	    fee.set_percent(fee_.get_percent());
	  }
	}
      }
    }(fee_));
}

int deposit::send(std::string address, int satoshi, int type){
  int working_satoshi = satoshi;
  LOCK_RUN(fee_lock, [](int *working_satoshi){
      for(int i = 0;i < fee;i++){
	const long double fee_percent = fee[i].get_percent();
	const satoshi_t fee_size = fee_percent*(*working_satoshi);
	if(fee_size != 0){
	  tx_out_t tx_tmp(fee[i].get_address(), fee_size);
	  print("adding the fee of " + std::to_string(fee_size) + " satoshi (" + std::to_string(fee_percent) + ") to " + fee[i].get_address(), P_NOTICE);
	  tx::add_tx_out(tx_tmp);
	}
	*working_satoshi -= fee_size;
      }
    }(&working_satoshi));
  if(search_for_argv("--no-tx-blocks") != -1){
    tx::send_transaction_block();
    // no need to manually set a fee
  }
}
